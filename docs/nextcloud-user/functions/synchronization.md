# 同步文件
## 同步过程

同步过程将文件保存在两个单独的存储库中。同步时：
* 如果将文件添加到一个存储库，则会将其复制到另一个同步存储库。
* 在一个存储库中更改文件时，更改将传播到任何其他同步存储库。
* 如果在一个存储库中删除了某个文件，则会将其删除。

值得注意的是，Nextcloud同步过程不使用客户端系统，总是以服务器为主。这是Nextcloud同步过程与文件备份等其他系统之间的主要区别，其中只传播对文件或文件夹的更改以及添加新文件，但除非在备份中明确删除，否则永远不会删除这些文件和文件夹。

在同步期间，Nextcloud客户端会经常检查这两个存储库是否有更改。此过程称为同步运行。在同步运行之间，本地存储库由文件系统监视进程监视，该进程在编辑，添加或删除某些内容时立即启动同步运行。

## 按时间同步与etag
在客户端版本1.1发布之前，Nextcloud同步过程使用单个文件属性 - 文件修改时间 - 来确定哪个文件更新并且需要同步到另一个存储库。

该修改时间是文件的元数据的一部分。它在每个相关文件系统上都可用，并且是文件更改的典型指示器。修改时间戳不需要特殊操作来创建，并具有一般含义。同步的一个设计目标是不需要特殊的服务器组件。此设计目标是选择同步作为后端组件的原因。

要比较来自不同系统的两个文件的修改时间，同步必须在同一个基础上运行。在客户端版本1.1.0之前，同步需要两个设备存储库在完全相同的时间运行。通过在所有计算机上使用企业标准NTP时间同步来实现此要求。

由于此时序策略在不使用NTP的情况下相当脆弱，因此Nextcloud服务器提供了一个唯一的编号，只要文件发生更改，该编号就会发生变化。虽然此数字是唯一值，但它不是文件的哈希值。相反，它是随机选择的数字，在Etag 字段中传输。由于文件号在文件更改时会发生更改，因此可以确保其使用，以确定其中一个文件是否已更改，从而启动同步过程。

在Desktop Client 1.3.0发行版之前，如果时间偏差，同步过程可能会创建错误的冲突文件。原始文件和已更改文件仅在其时间戳中冲突，但在其内容中不冲突。如果文件不同，则此行为已更改为使用二进制检查。

与文件一样，目录也包含唯一的ID，只要修改了其中一个包含的文件或目录，该ID就会发生变化。因为这是一个递归过程，所以它显着减少了同步周期所需的工作量，因为客户端只分析具有修改ID的目录。

## 比较与冲突案例
如上所述，在同步运行期间，客户端必须首先检测两个存储库中的一个是否已更改文件。在本地存储库中，客户端遍历文件树，并将每个文件的修改时间与存储在其数据库中的预期值进行比较。如果值不相同，则客户端确定已在本地存储库中修改了该文件。

`注意`<br/>
`在本地方面，修改时间是用于检测变化的良好属性，因为该值不依赖于时移等。`

对于远程（即Nextcloud服务器）存储库，客户端将每个文件的etag与其预期值进行比较。同样，从客户端数据库查询预期的etag值。如果etag相同，则文件未更改且不会发生同步。

如果自上次同步运行以来本地和远程存储库上的文件都已更改，则无法轻易确定该文件的哪个版本应该使用该文件。但是，任何一方的改变都不会丢失。相反，会创建一个冲突案例。客户端通过重命名本地文件，附加冲突标签和时间戳以及将远程文件保存在原始文件名下来解决此冲突。

示例：假设`message.txt`中存在冲突，因为自上次同步运行以来，其内容在本地和远程都已更改。具有本地更改的本地文件将重命名为`message(conflict 201901018 153110).txt`，远程文件将下载并保存为message.txt。

冲突文件始终在客户端上创建，永远不会在服务器上创建。